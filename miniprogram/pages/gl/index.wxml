<!-- 统一顶部工具栏：语言 | 时间 | 设置 -->
<view class="top-bar">
  <view class="top-icon-btn {{zenMode ? 'inert' : ''}}" bindtap="onToggleLang" role="button">{{lang === 'zh' ? '中' : 'EN'}}</view>
  <text class="time-pill {{zenMode ? 'inert' : ''}}">{{currentTime}}</text>
  <view class="top-icon-btn settings-btn {{zenMode ? 'inert' : ''}}" bindtap="onToggleSettings" role="button">⚙</view>
  <!-- 第二行：左侧“切”按钮（与右侧“禅”按钮对称） -->
  <!-- 恢复原搜索放大镜；禅模式下隐藏但占位，避免布局跳动 -->
  <view class="top-icon-btn search-btn {{zenMode ? 'inert' : ''}}" bindtap="onToggleSearch" role="button"></view>
  <!-- 第二行：右侧“禅”按钮（位于设置按钮正下方） -->
  <view class="top-icon-btn zen-btn" bindtap="onToggleZenMode" role="button">禅</view>
  <!-- 第一行第三列：“切”按钮常驻，通过 inert 类淡入淡出（禅定下可见） -->
  <view class="top-icon-btn cut-btn {{zenMode ? '' : 'inert'}}" bindtap="onToggleCut" role="button">切</view>
  <!-- 提示信息（可选）：与时间保持同一行，不占宽度 -->
  <view class="top-tip {{hoverText ? 'visible' : ''}} {{zenMode ? 'inert' : ''}}">{{hoverText}}</view>
  <!-- 禅定诗句改为独立层：双容器交替，支持淡入淡出与位移 -->
</view>

<!-- 诗句独立层：固定覆盖在页面上，避免受工具栏布局影响 -->
<view wx:if="{{zenMode}}" class="poetry-layer">
  <view id="poetryA" class="poetry-item {{poetryA.visible?'visible':''}}" style="left: {{poetryA.x}}px; top: {{poetryA.y}}px; font-size: {{poetryFontSizePx}}px; transition: transform {{poetryA.moveMs}}ms linear, opacity {{poetryFadeMs}}ms ease-in-out; transform: translate3d({{poetryA.tx}}px, {{poetryA.ty}}px, 0);">
    <!-- 多层残影：不依赖 text-shadow，在微信小程序更稳定 -->
    <block wx:for="{{poetryTrailLayers}}" wx:key="index">
      <text class="poetry-text poetry-trail" style="opacity: {{item.alpha}}; transform: translate3d(0px, {{item.offset}}px, 0);">{{poetryA.text}}</text>
    </block>
    <text class="poetry-text">{{poetryA.text}}</text>
  </view>
  <view id="poetryB" class="poetry-item {{poetryB.visible?'visible':''}}" style="left: {{poetryB.x}}px; top: {{poetryB.y}}px; font-size: {{poetryFontSizePx}}px; transition: transform {{poetryB.moveMs}}ms linear, opacity {{poetryFadeMs}}ms ease-in-out; transform: translate3d({{poetryB.tx}}px, {{poetryB.ty}}px, 0);">
    <block wx:for="{{poetryTrailLayers}}" wx:key="index">
      <text class="poetry-text poetry-trail" style="opacity: {{item.alpha}}; transform: translate3d(0px, {{item.offset}}px, 0);">{{poetryB.text}}</text>
    </block>
    <text class="poetry-text">{{poetryB.text}}</text>
  </view>
</view>

<!-- 搜索面板遮罩：点击任意空白关闭，同时把触摸事件转交到渲染层（与国家面板一致） -->
<view wx:if="{{searchOpen}}" class="search-mask" bindtap="onCloseSearch" bindtouchstart="onSearchMaskTouchStart" bindtouchmove="onSearchMaskTouchMove" bindtouchend="onTouchEnd" bindtouchcancel="onTouchEnd"></view>

<!-- 搜索面板：出现输入框与候选列表 -->
<view class="search-panel" wx:if="{{searchOpen}}">
  <input class="search-input" placeholder="搜索国家或城市" value="{{searchQuery}}" bindinput="onSearchInput" focus="true" />
  <view class="search-list">
    <view wx:for="{{suggestions}}" wx:key="index" class="search-item" data-type="{{item.type}}" data-id="{{item.id}}" data-lat="{{item.lat}}" data-lon="{{item.lon}}" bindtap="onPickSuggestionOpen">
      <text class="search-item-text">{{item.display}}</text>
    </view>
    <view wx:if="{{suggestions.length===0 && searchQuery.length>=2}}" class="search-empty">无匹配项</view>
  </view>
</view>

<!-- 面板外点击关闭：透明遮罩，放在画布之上、面板之下 -->
<view wx:if="{{settingsOpen}}" class="settings-mask {{settingsFading?'fading-out':''}}" bindtap="onCloseSettings" bindtouchstart="onTouchStart" bindtouchmove="onTouchMove" bindtouchend="onTouchEnd" bindtouchcancel="onTouchEnd"></view>

<!-- 设置面板：移出滚动容器，保持与顶栏同层级，避免遮挡与层级冲突 -->
<view class="settings-panel {{settingsFading?'fading-out':''}}" wx:if="{{settingsOpen}}">
  <view class="settings-title">设置</view>
  <view class="settings-row">
    <text>夜间模式</text>
    <view class="toggle-group">
      <view class="toggle-btn {{nightMode?'active':''}}" data-key="nightMode" data-val="true" bindtap="onToggleOption" role="button">开</view>
      <view class="toggle-btn {{!nightMode?'active':''}}" data-key="nightMode" data-val="false" bindtap="onToggleOption" role="button">关</view>
    </view>
  </view>
  <view class="settings-row">
    <text>显示云层</text>
    <view class="toggle-group">
      <view class="toggle-btn {{showCloud?'active':''}}" data-key="showCloud" data-val="true" bindtap="onToggleOption" role="button">开</view>
      <view class="toggle-btn {{!showCloud?'active':''}}" data-key="showCloud" data-val="false" bindtap="onToggleOption" role="button">关</view>
    </view>
  </view>
  <view class="settings-row">
    <text>城市显示</text>
    <view class="qty-group">
      <view class="qty-btn {{cityTier==='none'?'active':''}}" data-val="none" bindtap="onSetCityTier" role="button">无</view>
      <view class="qty-btn {{cityTier==='key'?'active':''}}" data-val="key" bindtap="onSetCityTier" role="button">重点</view>
      <view class="qty-btn {{cityTier==='more'?'active':''}}" data-val="more" bindtap="onSetCityTier" role="button">更多</view>
    </view>
  </view>
  <view class="settings-row">
    <text>标签数量</text>
    <view class="qty-group">
      <view class="qty-btn {{labelQty==='none'?'active':''}}" data-val="none" bindtap="onSetLabelQty" role="button">无</view>
      <view class="qty-btn {{labelQty==='few'?'active':''}}" data-val="few" bindtap="onSetLabelQty" role="button">少</view>
      <view class="qty-btn {{labelQty==='default'?'active':''}}" data-val="default" bindtap="onSetLabelQty" role="button">默认</view>
      <view class="qty-btn {{labelQty==='many'?'active':''}}" data-val="many" bindtap="onSetLabelQty" role="button">多</view>
    </view>
  </view>
</view>

<scroll-view
  class="wrap"
  scroll-y="true"
  show-scrollbar="false"
  enable-passive="true"
  scroll-anchoring="false"
  scroll-top="{{scrollTop}}"
  bindscroll="onWheelZoom"
>
  <!-- 工具栏已在页面顶部固定，此处不再重复按钮 -->
  <canvas
    type="webgl"
    id="gl"
    disable-scroll="true"
    bindtouchstart="onTouchStart"
    bindtouchmove="onTouchMove"
    bindtouchend="onTouchEnd"
    bindtouchcancel="onTouchEnd"
  />
  <!-- 滚轮触发空间：在 scroll-view 中增加足够高度，确保 bindscroll 能触发（仅 PC 有效） -->
  <view class="wheel-space" wx:if="{{isPC}}"></view>
  
</scroll-view>

<!-- 底部缩放条：统一胶囊风格，保留原 slider（事件吃掉，避免冒泡到 canvas） -->
<view class="zoom-bar {{zenMode ? 'inert' : ''}}" catchtouchstart="onCatchTouchMove" catchtouchmove="onCatchTouchMove" catchtouchend="onCatchTouchMove">
  <slider class="zoom-slider"
          min="{{uiZoomMin}}" max="{{uiZoomMax}}" step="0.01"
          value="{{uiZoom}}"
          active-color="#78aadc"
          backgroundColor="#17283c"
          block-size="18"
          show-value="false"
          bindchanging="onZoomChanging"
          bindchange="onZoomChange" />
</view>

<!-- 国家信息面板遮罩：点击除语言按钮外的任意处关闭（与设置面板一致） -->
<!-- 允许穿透拖动：去掉 catchtouchmove，保留点击关闭 -->
<view wx:if="{{countryPanelOpen}}" class="country-mask {{countryPanelFading?'fading-out':''}}" bindtap="onCloseCountryPanel" bindtouchstart="onMaskTouchStart" bindtouchmove="onMaskTouchMove" bindtouchend="onTouchEnd" bindtouchcancel="onTouchEnd"></view>

<!-- 国家信息面板：点击国家后显示（保持画布可旋转；遮罩负责关闭） -->
<view class="country-panel {{countryPanelFading?'fading-out':''}}" wx:if="{{countryPanelOpen}}" style="top: {{countryPanelTop}}px" bindtouchstart="onPanelTouchStart" bindtouchmove="onPanelTouchMove" bindtouchend="onTouchEnd" bindtouchcancel="onTouchEnd">
  <view class="country-title">{{countryInfo.name || '未知'}}{{countryInfo.titleTzSuffix || ''}}</view>
  <view class="country-row"><text class="k">{{labels.capital}}</text><text class="v">{{countryInfo.capital || '--'}}</text></view>
  <view class="country-row"><text class="k">{{labels.area}}</text><text class="v">{{countryInfo.areaKm2 || '--'}} km²</text></view>
  <view class="country-row"><text class="k">{{labels.population}}</text><text class="v">{{countryInfo.population || '--'}}</text></view>
  <view class="country-row"><text class="k">{{labels.gdp}}</text><text class="v">{{lang==='zh' ? (countryInfo.gdp || '--') + ' 万亿美元' : (countryInfo.gdp || '--') + ' USD trillion'}}</text></view>
  </view>
